<div x-data="{
    open: false,
    menuStyle: {},
    updateMenuPosition() {
        const trigger = this.$refs.trigger;
        if (!trigger) return;
        const rect = trigger.getBoundingClientRect();
        this.menuStyle = {
            position: 'fixed',
            top: (rect.bottom + 2) + 'px',
            left: rect.left + 'px',
            width: rect.width + 'px'
        };
    }
}"
x-init="if ($store.downloadManager.deviceId === null || $store.downloadManager.deviceId === '') { {% if default_device_id %}$store.downloadManager.deviceId = '{{ default_device_id }}';{% if transfer_only %}htmx.ajax('GET', '/devices/{{ default_device_id }}/transfer-config/', { target: '#transfer-config-container' });{% endif %}{% elif not transfer_only %}$store.downloadManager.deviceId = '';{% endif %} }"
@click.outside="open = false">
    <label class="block text-base font-medium text-[var(--color-text)] mb-3">
        {% if transfer_only %}Select Device (for transfer){% else %}Device Configuration{% endif %}
    </label>

    {% if devices %}
    <!-- Dropdown -->
    <div class="retro-select-dropdown mb-4">
        <!-- Trigger Button -->
        <button type="button"
                x-ref="trigger"
                @click="open = !open; if(open) updateMenuPosition()"
                :aria-expanded="open"
                class="retro-select-trigger">
            <div class="trigger-content">
                <!-- No device selected (only when not transfer_only) -->
                {% if not transfer_only %}
                <template x-if="$store.downloadManager.deviceId === ''">
                    <div>
                        <span class="font-medium text-[var(--color-text)]">No device</span>
                        <p class="text-base text-[var(--color-text-muted)]">Use default folder structure</p>
                    </div>
                </template>
                {% endif %}

                <!-- Placeholder when no selection (transfer_only mode) -->
                {% if transfer_only %}
                <template x-if="$store.downloadManager.deviceId === ''">
                    <span class="retro-select-placeholder">Select a device...</span>
                </template>
                {% endif %}

                <!-- Show selected device -->
                {% for device in devices %}
                <template x-if="$store.downloadManager.deviceId === '{{ device.id }}'">
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center gap-2">
                            <svg class="w-4 h-4 text-[var(--color-gold)] flex-shrink-0" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M21 6H3c-1.1 0-2 .9-2 2v8c0 1.1.9 2 2 2h18c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2zm-10 7H8v3H6v-3H3v-2h3V8h2v3h3v2zm4.5 2c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zm4-3c-.83 0-1.5-.67-1.5-1.5S18.67 9 19.5 9s1.5.67 1.5 1.5-.67 1.5-1.5 1.5z"/>
                            </svg>
                            <span class="font-medium text-[var(--color-text)] truncate">{{ device.name }}</span>
                            {% if device.id == default_device_id %}
                            <span class="retro-badge retro-badge-gold text-base flex-shrink-0">Default</span>
                            {% endif %}
                        </div>
                        <div class="flex items-center gap-2 mt-1">
                            <code class="retro-code-inline text-base truncate">{{ device.root_path }}</code>
                            {% if device.transfer_type %}
                            <span class="retro-badge retro-badge-teal text-base flex-shrink-0">{{ device.transfer_type|upper }}</span>
                            {% endif %}
                        </div>
                    </div>
                </template>
                {% endfor %}
            </div>
            <!-- Chevron -->
            <svg class="trigger-chevron" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
            </svg>
        </button>

        <!-- Dropdown Menu -->
        <div x-show="open"
             x-transition:enter="transition ease-out duration-100"
             x-transition:enter-start="opacity-0 -translate-y-1"
             x-transition:enter-end="opacity-100 translate-y-0"
             x-transition:leave="transition ease-in duration-75"
             x-transition:leave-start="opacity-100 translate-y-0"
             x-transition:leave-end="opacity-0 -translate-y-1"
             :style="menuStyle"
             class="retro-select-menu">

            <!-- "No device" option (only when not transfer_only) -->
            {% if not transfer_only %}
            <div @click="$store.downloadManager.deviceId = ''; open = false"
                 :class="{ 'selected': $store.downloadManager.deviceId === '' }"
                 class="retro-select-option">
                <div class="flex-1">
                    <span class="font-medium text-[var(--color-text)]">No device</span>
                    <p class="text-base text-[var(--color-text-muted)]">Use default folder structure</p>
                </div>
            </div>
            {% endif %}

            <!-- Device options -->
            {% for device in devices %}
            <div @click="$store.downloadManager.deviceId = '{{ device.id }}'; open = false; {% if transfer_only %}htmx.ajax('GET', '/devices/{{ device.id }}/transfer-config/', { target: '#transfer-config-container' }){% endif %}"
                 :class="{ 'selected': $store.downloadManager.deviceId === '{{ device.id }}' }"
                 class="retro-select-option">
                <div class="flex-1 min-w-0">
                    <div class="flex items-center gap-2">
                        <svg class="w-4 h-4 text-[var(--color-gold)] flex-shrink-0" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M21 6H3c-1.1 0-2 .9-2 2v8c0 1.1.9 2 2 2h18c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2zm-10 7H8v3H6v-3H3v-2h3V8h2v3h3v2zm4.5 2c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zm4-3c-.83 0-1.5-.67-1.5-1.5S18.67 9 19.5 9s1.5.67 1.5 1.5-.67 1.5-1.5 1.5z"/>
                        </svg>
                        <span class="font-medium text-[var(--color-text)] truncate">{{ device.name }}</span>
                        {% if device.id == default_device_id %}
                        <span class="retro-badge retro-badge-gold text-base flex-shrink-0">Default</span>
                        {% endif %}
                    </div>
                    <div class="flex items-center gap-2 mt-1">
                        <code class="retro-code-inline text-base truncate">{{ device.root_path }}</code>
                        {% if device.transfer_type %}
                        <span class="retro-badge retro-badge-teal text-base flex-shrink-0">{{ device.transfer_type|upper }}</span>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% else %}
    <!-- No devices configured -->
    <div class="p-4 text-center text-[var(--color-text-muted)] bg-[var(--color-bg)] border-2 border-dashed border-[var(--color-border)] mb-4">
        <p class="mb-2">No devices configured</p>
        <a href="{% url 'devices:device_create' %}" target="_blank" class="text-[var(--color-primary)] hover:underline text-base">
            Create a device &rarr;
        </a>
    </div>
    {% endif %}

    {% if transfer_only %}
    <div id="transfer-config-container"></div>
    {% endif %}

    <!-- Save as Default -->
    {% if devices %}
    <div class="flex items-center justify-between pt-3 border-t-2 border-[var(--color-border)]">
        <label class="inline-flex items-center gap-2 cursor-pointer">
            <input type="checkbox" id="save-as-default" x-model="$store.downloadManager.saveAsDefault" class="retro-checkbox">
            <span class="text-base text-[var(--color-text)]">Save as default</span>
        </label>
        <a href="{% url 'devices:device_list' %}" target="_blank" class="text-[var(--color-primary)] hover:underline text-base">
            Manage devices &rarr;
        </a>
    </div>
    {% endif %}
</div>
