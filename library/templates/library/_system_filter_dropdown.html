{# System multi-select dropdown #}
<div class="relative" x-data="{ searchQuery: '', systemsLoaded: false }">
    {# Trigger button #}
    <button @click="systemDropdownOpen = !systemDropdownOpen; if(systemDropdownOpen) { $nextTick(() => { $refs.systemSearch?.focus(); systemsLoaded = false; htmx.ajax('GET', '{% url 'library:filter_systems' %}?search_query=' + encodeURIComponent($store.searchFilters.query || '') + '&genre=' + $store.searchFilters.genres.map(g => g.slug).join(',') + '&rating_op=' + ($store.searchFilters.ratingOp || '') + '&rating_min=' + ($store.searchFilters.ratingMin || '') + '&rating_max=' + ($store.searchFilters.ratingMax || ''), {target: '#system-options', swap: 'innerHTML'}); systemsLoaded = true; }) }"
            type="button"
            class="retro-select-trigger w-full"
            :aria-expanded="systemDropdownOpen">
        <div class="trigger-content truncate">
            <template x-if="$store.searchFilters.systems.length === 0">
                <span class="text-[var(--color-text-muted)] italic">Any system</span>
            </template>
            <template x-if="$store.searchFilters.systems.length === 1">
                <span x-text="$store.searchFilters.systems[0].name"></span>
            </template>
            <template x-if="$store.searchFilters.systems.length > 1">
                <span x-text="$store.searchFilters.systems.length + ' systems selected'"></span>
            </template>
        </div>
        <svg class="trigger-chevron" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
        </svg>
    </button>

    {# Dropdown menu #}
    <div x-show="systemDropdownOpen"
         x-transition:enter="transition ease-out duration-100"
         x-transition:enter-start="opacity-0 scale-95"
         x-transition:enter-end="opacity-100 scale-100"
         x-transition:leave="transition ease-in duration-75"
         x-transition:leave-start="opacity-100 scale-100"
         x-transition:leave-end="opacity-0 scale-95"
         @click.away="systemDropdownOpen = false"
         class="retro-filter-dropdown">
        {# Search input #}
        <div class="p-2 border-b-2 border-[var(--color-border)]">
            <input type="text"
                   x-ref="systemSearch"
                   x-model="searchQuery"
                   @input.debounce.200ms="htmx.ajax('GET', '{% url 'library:filter_systems' %}?q=' + searchQuery + '&search_query=' + encodeURIComponent($store.searchFilters.query || '') + '&selected=' + $store.searchFilters.systems.map(s => s.slug).join(',') + '&genre=' + $store.searchFilters.genres.map(g => g.slug).join(',') + '&rating_op=' + ($store.searchFilters.ratingOp || '') + '&rating_min=' + ($store.searchFilters.ratingMin || '') + '&rating_max=' + ($store.searchFilters.ratingMax || ''), {target: '#system-options', swap: 'innerHTML'})"
                   placeholder="Search systems..."
                   class="retro-input w-full text-base py-1">
        </div>

        {# Options list - loaded when dropdown opens #}
        <div id="system-options"
             class="max-h-60 overflow-y-auto">
            <div class="p-4 text-center text-base text-[var(--color-text-muted)]">Loading...</div>
        </div>
    </div>
</div>
